<script>
(function() {
  // Отладочная информация
  console.log('TelegramAuth: Initializing...');
  console.log('TelegramAuth: window.Telegram exists?', !!window.Telegram);
  console.log('TelegramAuth: window.Telegram.WebApp exists?', !!window.Telegram?.WebApp);
  
  // Ждём загрузки DOM и Telegram WebApp
  function initTelegram() {
    const hasTelegram = !!window.Telegram?.WebApp;
    console.log('TelegramAuth: initTelegram called, hasTelegram:', hasTelegram);
    
    if (!hasTelegram) {
      console.warn('TelegramAuth: Telegram WebApp not available. Site is not opened in Telegram Mini App.');
      // telegramGate компонент уже обработает блокировку доступа
      return;
    }
    
    const tg = window.Telegram.WebApp;
    console.log('TelegramAuth: Telegram WebApp initialized', tg);
    
    // Инициализация Telegram WebApp
    tg.ready();
    tg.expand();
    
    // Показываем кнопку "Назад" только если не на главной странице
    const currentPath = window.location.pathname;
    const isHomePage = currentPath === '/' || currentPath === '/index.html' || currentPath === '/index/';
    console.log('TelegramAuth: currentPath:', currentPath, 'isHomePage:', isHomePage);
    
    if (!isHomePage) {
      console.log('TelegramAuth: Showing BackButton');
      tg.BackButton.show();
      
      // Обработка нажатия на кнопку "Назад"
      tg.BackButton.onClick(() => {
        console.log('TelegramAuth: BackButton clicked, navigating to /');
        window.location.href = '/';
      });
    } else {
      console.log('TelegramAuth: Hiding BackButton (home page)');
      tg.BackButton.hide();
    }
    
    // Показываем username пользователя
    const userInfo = document.getElementById('user-info');
    console.log('TelegramAuth: userInfo element:', userInfo);
    if (userInfo) {
      const usernameEl = userInfo.querySelector('.user-username');
      const user = tg.initDataUnsafe?.user;
      console.log('TelegramAuth: user from initDataUnsafe:', user);
      
      if (user) {
        const displayName = user.username 
          ? `@${user.username}` 
          : (user.first_name || user.last_name || 'Пользователь');
        
        console.log('TelegramAuth: displayName:', displayName);
        if (usernameEl) {
          usernameEl.textContent = displayName;
          userInfo.style.display = 'flex';
          console.log('TelegramAuth: Username displayed');
        }
      } else {
        console.warn('TelegramAuth: User data not available in initDataUnsafe');
      }
    }
    
    // Защита от копирования через Telegram API
    tg.disableSelection();
    
    // Подтверждение закрытия
    tg.enableClosingConfirmation();
    
    // Дополнительная защита через JavaScript
    document.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      return false;
    });
    
    document.addEventListener('copy', (e) => {
      e.preventDefault();
      return false;
    });
    
    document.addEventListener('selectstart', (e) => {
      e.preventDefault();
      return false;
    });
    
    document.addEventListener('dragstart', (e) => {
      e.preventDefault();
      return false;
    });
    
    // Запрет масштабирования жестами (двойной тап)
    let lastTouchEnd = 0;
    document.addEventListener('touchend', (e) => {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        e.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
    
    // Запрет масштабирования через клавиатуру
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && (e.key === '+' || e.key === '-' || e.key === '=' || e.key === '0')) {
        e.preventDefault();
        return false;
      }
    });
  }
  
  // Инициализация при загрузке
  function runInit() {
    if (document.readyState === 'loading') {
      console.log('TelegramAuth: DOM is loading, waiting for DOMContentLoaded');
      document.addEventListener('DOMContentLoaded', initTelegram);
    } else {
      console.log('TelegramAuth: DOM already loaded, calling initTelegram immediately');
      initTelegram();
    }
    
    // Также пробуем инициализировать с задержкой (на случай если Telegram загружается асинхронно)
    setTimeout(() => {
      console.log('TelegramAuth: Delayed init attempt');
      if (window.Telegram?.WebApp) {
        initTelegram();
      }
    }, 500);
    
    // Ещё одна попытка через 2 секунды
    setTimeout(() => {
      console.log('TelegramAuth: Second delayed init attempt');
      if (window.Telegram?.WebApp) {
        initTelegram();
      }
    }, 2000);
  }
  
  runInit();
})();
</script>
