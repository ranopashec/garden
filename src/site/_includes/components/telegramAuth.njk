<script>
(function() {
  // Отладочная информация
  console.log('TelegramAuth: Initializing...');
  console.log('TelegramAuth: window.Telegram exists?', !!window.Telegram);
  console.log('TelegramAuth: window.Telegram.WebApp exists?', !!window.Telegram?.WebApp);
  
  // Ждём загрузки DOM и Telegram WebApp
  function initTelegram() {
    const hasTelegram = !!window.Telegram?.WebApp;
    console.log('TelegramAuth: initTelegram called, hasTelegram:', hasTelegram);
    
    if (!hasTelegram) {
      console.warn('TelegramAuth: Telegram WebApp not available. Site is not opened in Telegram Mini App.');
      // telegramGate компонент уже обработает блокировку доступа
      return;
    }
    
    const tg = window.Telegram.WebApp;
    console.log('TelegramAuth: Telegram WebApp initialized', tg);
    
    // Инициализация Telegram WebApp
    tg.ready();
    tg.expand();
    
    // Показываем кнопку "Назад" только если не на главной странице
    const currentPath = window.location.pathname;
    const isHomePage = currentPath === '/' || currentPath === '/index.html' || currentPath === '/index/';
    console.log('TelegramAuth: currentPath:', currentPath, 'isHomePage:', isHomePage);
    
    if (!isHomePage) {
      console.log('TelegramAuth: Showing BackButton');
      tg.BackButton.show();
      
      // Обработка нажатия на кнопку "Назад"
      tg.BackButton.onClick(() => {
        console.log('TelegramAuth: BackButton clicked, navigating to /');
        window.location.href = '/';
      });
    } else {
      console.log('TelegramAuth: Hiding BackButton (home page)');
      tg.BackButton.hide();
    }
    
    // Показываем username пользователя
    const userInfo = document.getElementById('user-info');
    console.log('TelegramAuth: userInfo element:', userInfo);
    if (userInfo) {
      const usernameEl = userInfo.querySelector('.user-username');
      const subscriptionDaysEl = document.getElementById('user-subscription-days');
      const user = tg.initDataUnsafe?.user;
      console.log('TelegramAuth: user from initDataUnsafe:', user);
      
      if (user) {
        const displayName = user.username 
          ? `@${user.username}` 
          : (user.first_name || user.last_name || 'Пользователь');
        
        console.log('TelegramAuth: displayName:', displayName);
        if (usernameEl) {
          usernameEl.textContent = displayName;
          userInfo.style.display = 'flex';
          console.log('TelegramAuth: Username displayed');
        }
        
        // Проверяем подписку и показываем дни
        checkSubscription(user.id, subscriptionDaysEl);
      } else {
        console.warn('TelegramAuth: User data not available in initDataUnsafe');
      }
    }
    
    // Функция проверки подписки с кэшированием в localStorage
    async function checkSubscription(telegramId, subscriptionDaysEl) {
      try {
        // Проверяем кэш в localStorage
        const cacheKey = `subscription_${telegramId}`;
        const cachedData = localStorage.getItem(cacheKey);
        
        let data;
        if (cachedData) {
          try {
            const parsed = JSON.parse(cachedData);
            const cacheTime = parsed.timestamp || 0;
            const now = Date.now();
            // Используем кэш если он не старше 5 минут
            if (now - cacheTime < 5 * 60 * 1000) {
              data = parsed.data;
              console.log('TelegramAuth: Using cached subscription data');
            }
          } catch (e) {
            console.warn('TelegramAuth: Failed to parse cache', e);
          }
        }
        
        // Если кэша нет или он устарел - делаем запрос
        if (!data) {
          const response = await fetch('/api/check-access', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ telegramId: telegramId })
          });
          
          if (!response.ok) {
            console.error('TelegramAuth: Failed to check subscription', response.status);
            return;
          }
          
          data = await response.json();
          
          // Сохраняем в кэш
          localStorage.setItem(cacheKey, JSON.stringify({
            data: data,
            timestamp: Date.now()
          }));
          console.log('TelegramAuth: Subscription data cached');
        }
        
        // Отображаем отладочную информацию
        displayDebugInfo(telegramId, data);
        
        if (data.expiresAt && subscriptionDaysEl) {
          const expiresAt = new Date(data.expiresAt);
          const now = new Date();
          const diffTime = expiresAt - now;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          
          if (diffDays > 0 && data.hasAccess) {
            // Подписка активна - показываем дни
            subscriptionDaysEl.textContent = `${diffDays} дн.`;
            subscriptionDaysEl.style.display = 'inline';
            subscriptionDaysEl.style.marginLeft = '8px';
            console.log('TelegramAuth: Subscription active, days left:', diffDays);
            // Скрываем плашку подписки
            updateSubscriptionBanner(false);
          } else {
            // Подписка истекла или нет доступа - скрываем дни
            subscriptionDaysEl.style.display = 'none';
            // Показываем плашку подписки
            updateSubscriptionBanner(true);
            console.log('TelegramAuth: Subscription expired or no access');
          }
        } else {
          // Подписки нет - скрываем дни
          if (subscriptionDaysEl) {
            subscriptionDaysEl.style.display = 'none';
          }
          // Показываем плашку подписки
          updateSubscriptionBanner(true);
          console.log('TelegramAuth: No subscription');
        }
      } catch (error) {
        console.error('TelegramAuth: Error checking subscription', error);
      }
    }
    
    // Функция отображения отладочной информации
    function displayDebugInfo(telegramId, data) {
      let debugDiv = document.getElementById('debug-info');
      if (!debugDiv) {
        debugDiv = document.createElement('div');
        debugDiv.id = 'debug-info';
        debugDiv.style.cssText = 'position: fixed; top: 60px; right: 16px; z-index: 1000; background: rgba(0, 0, 0, 0.9); color: #fff; padding: 12px; border-radius: 8px; font-size: 11px; font-family: monospace; max-width: 350px; line-height: 1.4; overflow-y: auto; max-height: 400px;';
        document.body.appendChild(debugDiv);
      }
      
      const now = new Date();
      const expiresDate = data.expiresAt ? new Date(data.expiresAt) : null;
      const daysLeft = expiresDate ? Math.ceil((expiresDate - now) / (1000 * 60 * 60 * 24)) : null;
      const isExpired = expiresDate ? expiresDate < now : null;
      
      debugDiv.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 8px; color: #4a9eff;">DEBUG INFO</div>
        <div><strong>Telegram ID:</strong> ${telegramId} (${typeof telegramId})</div>
        <div><strong>Has Access:</strong> <span style="color: ${data.hasAccess ? '#0f0' : '#f00'}">${data.hasAccess ? '✅ Yes' : '❌ No'}</span></div>
        <div><strong>User Found:</strong> ${data.debug?.userDataFound !== undefined ? (data.debug.userDataFound ? '✅ Yes' : '❌ No') : 'N/A'}</div>
        <div><strong>Expires At:</strong> ${data.expiresAt || 'N/A'}</div>
        ${expiresDate ? `<div><strong>Expires Date:</strong> ${expiresDate.toISOString()}</div>` : ''}
        ${expiresDate ? `<div><strong>Now:</strong> ${now.toISOString()}</div>` : ''}
        ${daysLeft !== null ? `<div><strong>Days Left:</strong> <span style="color: ${daysLeft > 0 ? '#0f0' : '#f00'}">${daysLeft}</span></div>` : ''}
        ${isExpired !== null ? `<div><strong>Is Expired:</strong> <span style="color: ${isExpired ? '#f00' : '#0f0'}">${isExpired ? 'Yes' : 'No'}</span></div>` : ''}
        ${data.debug ? `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #333;"><strong>Raw Debug:</strong><pre style="font-size: 10px; overflow-x: auto;">${JSON.stringify(data.debug, null, 2)}</pre></div>` : ''}
      `;
    }
    
    // Функция обновления плашки подписки
    function updateSubscriptionBanner(showBanner) {
      let banner = document.getElementById('subscription-banner');
      
      if (showBanner) {
        // Показываем плашку если подписки нет
        if (!banner) {
          banner = document.createElement('div');
          banner.id = 'subscription-banner';
          banner.className = 'subscription-banner';
          banner.innerHTML = '<a href="https://t.me/lidevty_manager" target="_blank" style="text-decoration: none; color: inherit; display: block; width: 100%;">Полный доступ по подписке</a>';
          document.body.appendChild(banner);
        }
        banner.style.display = 'block';
      } else {
        // Скрываем плашку если подписка есть
        if (banner) {
          banner.style.display = 'none';
        }
      }
    }
    
    // Защита от копирования через Telegram API
    tg.disableSelection();
    
    // Подтверждение закрытия
    tg.enableClosingConfirmation();
    
    // Дополнительная защита через JavaScript
    document.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      return false;
    });
    
    document.addEventListener('copy', (e) => {
      e.preventDefault();
      return false;
    });
    
    document.addEventListener('selectstart', (e) => {
      e.preventDefault();
      return false;
    });
    
    document.addEventListener('dragstart', (e) => {
      e.preventDefault();
      return false;
    });
    
    // Запрет масштабирования жестами (двойной тап)
    let lastTouchEnd = 0;
    document.addEventListener('touchend', (e) => {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        e.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
    
    // Запрет масштабирования через клавиатуру
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && (e.key === '+' || e.key === '-' || e.key === '=' || e.key === '0')) {
        e.preventDefault();
        return false;
      }
    });
  }
  
  // Инициализация при загрузке
  function runInit() {
    if (document.readyState === 'loading') {
      console.log('TelegramAuth: DOM is loading, waiting for DOMContentLoaded');
      document.addEventListener('DOMContentLoaded', initTelegram);
    } else {
      console.log('TelegramAuth: DOM already loaded, calling initTelegram immediately');
      initTelegram();
    }
    
    // Также пробуем инициализировать с задержкой (на случай если Telegram загружается асинхронно)
    setTimeout(() => {
      console.log('TelegramAuth: Delayed init attempt');
      if (window.Telegram?.WebApp) {
        initTelegram();
      }
    }, 500);
    
    // Ещё одна попытка через 2 секунды
    setTimeout(() => {
      console.log('TelegramAuth: Second delayed init attempt');
      if (window.Telegram?.WebApp) {
        initTelegram();
      }
    }, 2000);
  }
  
  runInit();
})();
</script>
