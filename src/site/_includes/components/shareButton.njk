<div class="share-button-container">
  <button class="share-button" onclick="shareArticle()" title="Поделиться" data-share-param="{% if shareParam %}{{ shareParam }}{% else %}index{% endif %}">
    <svg class="share-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M21.154 2.571a.9.9 0 0 0-1.018.25l-8.2 7.428a.5.5 0 0 1-.672 0L3.864 2.821A.9.9 0 0 0 2 3.428v16.286a.9.9 0 0 0 1.836.178l6.5-5.143a.5.5 0 0 1 .664 0l6.5 5.143a.9.9 0 0 0 1.836-.178V3.428a.9.9 0 0 0-.182-.857z" fill="currentColor" stroke="currentColor" stroke-width="0.3"/>
    </svg>
  </button>
</div>

<script>
function shareArticle(event) {
  if (window.Telegram?.WebApp) {
    const tg = window.Telegram.WebApp;
    
    // Получаем shareParam из data-атрибута кнопки
    const button = (event?.target?.closest('.share-button')) || document.querySelector('.share-button');
    let shareParam = button?.dataset?.shareParam;
    
    // Если shareParam не найден, вычисляем из URL
    if (!shareParam || shareParam === '') {
      const path = window.location.pathname.replace(/^\/+|\/+$/g, '');
      shareParam = path === '' ? 'index' : path.replace(/^notes\//, '');
    }
    
    // Получаем bot username из initData
    const botUsername = tg.initDataUnsafe?.bot?.username;
    
    if (!botUsername) {
      // Если нет bot username, копируем обычную ссылку
      if (navigator.clipboard) {
        navigator.clipboard.writeText(window.location.href).then(() => {
          tg.showAlert('Ссылка скопирована в буфер обмена!');
        });
      }
      return;
    }
    
    // Используем shareParam напрямую (уже без слэшей)
    const startParam = shareParam;
    
    // Создаём ссылку для открытия статьи в мини-приложении
    // Формат: https://t.me/botusername/appname?startapp=article_path
    const appName = botUsername;
    const miniAppUrl = `https://t.me/${botUsername}/${appName}?startapp=${encodeURIComponent(startParam)}`;
    
    // Копируем ссылку в буфер обмена
    if (navigator.clipboard) {
      navigator.clipboard.writeText(miniAppUrl).then(() => {
        tg.showAlert('Ссылка скопирована! Теперь вы можете поделиться ею.');
      }).catch(() => {
        tg.showAlert('Ссылка: ' + miniAppUrl);
      });
    } else {
      tg.showAlert('Ссылка: ' + miniAppUrl);
    }
  } else {
    // Если не в Telegram, копируем обычную ссылку
    if (navigator.clipboard) {
      navigator.clipboard.writeText(window.location.href).then(() => {
        alert('Ссылка скопирована в буфер обмена!');
      });
    } else {
      alert('Ссылка: ' + window.location.href);
    }
  }
}

// Обработка start_param при загрузке страницы
(function() {
  if (window.Telegram?.WebApp) {
    const tg = window.Telegram.WebApp;
    const startParam = tg.initDataUnsafe?.start_param;
    
    if (startParam) {
      // Если есть start_param, перенаправляем на соответствующую статью
      // start_param в формате "article_path" (без слэшей)
      let targetPath = decodeURIComponent(startParam);
      
      // Если это "index", перенаправляем на главную
      if (targetPath === 'index') {
        targetPath = '/';
      } else {
        // Формируем путь: /permalink/
        // Убираем возможные слэши и добавляем их программно
        targetPath = targetPath.replace(/^\/+|\/+$/g, '');
        targetPath = `/${targetPath}/`;
      }
      
      // Перенаправляем только если путь отличается от текущего
      if (targetPath !== window.location.pathname) {
        window.location.href = targetPath;
      }
    }
  }
})();
</script>

