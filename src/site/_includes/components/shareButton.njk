<div class="share-button-container">
  <button class="share-button" onclick="shareArticle()" title="Поделиться" 
          data-share-param="{% if shareParam %}{{ shareParam }}{% else %}index{% endif %}"
          data-bot-username="{% if meta.botUsername %}{{ meta.botUsername }}{% endif %}">
    <svg class="share-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="currentColor"/>
    </svg>
  </button>
</div>

<script>
function shareArticle(event) {
  if (window.Telegram?.WebApp) {
    const tg = window.Telegram.WebApp;
    
    // Получаем shareParam из data-атрибута кнопки
    const button = (event?.target?.closest('.share-button')) || document.querySelector('.share-button');
    let shareParam = button?.dataset?.shareParam;
    
    // Если shareParam не найден, вычисляем из URL
    if (!shareParam || shareParam === '') {
      const path = window.location.pathname.replace(/^\/+|\/+$/g, '');
      shareParam = path === '' ? 'index' : path.replace(/^notes\//, '');
    }
    
    // Получаем bot username из разных источников
    // 1. Из data-атрибута кнопки (из meta.botUsername)
    let botUsername = button?.dataset?.botUsername;
    
    // 2. Из initDataUnsafe (Telegram WebApp API)
    if (!botUsername) {
      botUsername = tg.initDataUnsafe?.bot?.username;
    }
    
    // 3. Если не получили из initDataUnsafe, пробуем из initData
    if (!botUsername && tg.initData) {
      try {
        const urlParams = new URLSearchParams(tg.initData);
        const botStr = urlParams.get('bot');
        if (botStr) {
          const bot = JSON.parse(botStr);
          botUsername = bot.username;
        }
      } catch (e) {
        console.error('Error parsing bot from initData:', e);
      }
    }
    
    // Если username всё ещё не определён, показываем ошибку
    if (!botUsername) {
      console.error('Bot username not found. initDataUnsafe:', tg.initDataUnsafe, 'button dataset:', button?.dataset);
      if (navigator.clipboard) {
        navigator.clipboard.writeText(window.location.href).then(() => {
          tg.showAlert('Ссылка скопирована в буфер обмена!');
        });
      }
      return;
    }
    
    // Используем shareParam напрямую (уже без слэшей)
    const startParam = shareParam;
    
    // Создаём ссылку для открытия статьи в мини-приложении
    // Формат: https://t.me/botusername/appname?startapp=article_path
    // appname обычно совпадает с botusername
    const appName = botUsername;
    const miniAppUrl = `https://t.me/${botUsername}/${appName}?startapp=${encodeURIComponent(startParam)}`;
    
    console.log('Sharing URL:', miniAppUrl, 'startParam:', startParam, 'botUsername:', botUsername);
    
    // Копируем ссылку в буфер обмена
    if (navigator.clipboard) {
      navigator.clipboard.writeText(miniAppUrl).then(() => {
        tg.showAlert('Ссылка скопирована! Теперь вы можете поделиться ею.');
      }).catch((err) => {
        console.error('Clipboard error:', err);
        tg.showAlert('Ссылка: ' + miniAppUrl);
      });
    } else {
      tg.showAlert('Ссылка: ' + miniAppUrl);
    }
  } else {
    // Если не в Telegram, копируем обычную ссылку
    if (navigator.clipboard) {
      navigator.clipboard.writeText(window.location.href).then(() => {
        alert('Ссылка скопирована в буфер обмена!');
      });
    } else {
      alert('Ссылка: ' + window.location.href);
    }
  }
}

// Обработка start_param при загрузке страницы
(function() {
  if (window.Telegram?.WebApp) {
    const tg = window.Telegram.WebApp;
    const startParam = tg.initDataUnsafe?.start_param;
    
    if (startParam) {
      // Если есть start_param, перенаправляем на соответствующую статью
      // start_param в формате "article_path" (без слэшей)
      let targetPath = decodeURIComponent(startParam);
      
      // Если это "index", перенаправляем на главную
      if (targetPath === 'index') {
        targetPath = '/';
      } else {
        // Формируем путь: /permalink/
        // Убираем возможные слэши и добавляем их программно
        targetPath = targetPath.replace(/^\/+|\/+$/g, '');
        targetPath = `/${targetPath}/`;
      }
      
      // Перенаправляем только если путь отличается от текущего
      if (targetPath !== window.location.pathname) {
        window.location.href = targetPath;
      }
    }
  }
})();
</script>

