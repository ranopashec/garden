<div class="share-button-container">
  <button class="share-button" id="share-button" title="Поделиться">
    <svg class="share-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="currentColor"/>
    </svg>
  </button>
</div>

<script>
(function() {
  // Получаем shareParam из frontmatter через data-атрибут страницы
  function getShareParam() {
    // Пробуем получить из data-атрибута body или из URL
    const body = document.body;
    const shareParam = body.dataset.shareParam;
    
    if (shareParam) {
      return shareParam;
    }
    
    // Вычисляем из URL
    const path = window.location.pathname.replace(/^\/+|\/+$/g, '');
    if (!path || path === '') {
      return 'index';
    }
    // Убираем "notes/" если есть
    return path.replace(/^notes\//, '');
  }
  
  // Получаем bot username
  function getBotUsername() {
    if (!window.Telegram?.WebApp) {
      return null;
    }
    
    const tg = window.Telegram.WebApp;
    
    // 1. Из initDataUnsafe (самый надежный способ)
    let botUsername = tg.initDataUnsafe?.bot?.username;
    
    // 2. Из data-атрибута body (из meta.botUsername)
    if (!botUsername) {
      const body = document.body;
      botUsername = body.dataset.botUsername;
    }
    
    // 3. Из initData напрямую
    if (!botUsername && tg.initData) {
      try {
        const urlParams = new URLSearchParams(tg.initData);
        const botStr = urlParams.get('bot');
        if (botStr) {
          const bot = JSON.parse(botStr);
          botUsername = bot.username;
        }
      } catch (e) {
        console.error('Error parsing bot from initData:', e);
      }
    }
    
    return botUsername;
  }
  
  // Функция шаринга
  function shareArticle() {
    if (!window.Telegram?.WebApp) {
      // Если не в Telegram, используем обычный шаринг
      if (navigator.clipboard) {
        navigator.clipboard.writeText(window.location.href).then(() => {
          alert('Ссылка скопирована в буфер обмена!');
        });
      }
      return;
    }
    
    const tg = window.Telegram.WebApp;
    const shareParam = getShareParam();
    const botUsername = getBotUsername();
    
    if (!botUsername) {
      console.error('Bot username not found');
      if (navigator.clipboard) {
        navigator.clipboard.writeText(window.location.href).then(() => {
          tg.showAlert('Ссылка скопирована в буфер обмена!');
        });
      }
      return;
    }
    
    // Создаём ссылку для мини-приложения
    // Формат: https://t.me/botusername/appname?startapp=shareParam
    const appName = botUsername; // Обычно совпадает с username
    const miniAppUrl = `https://t.me/${botUsername}/${appName}?startapp=${encodeURIComponent(shareParam)}`;
    
    // Копируем в буфер обмена
    if (navigator.clipboard) {
      navigator.clipboard.writeText(miniAppUrl).then(() => {
        tg.showAlert('Ссылка скопирована! Теперь вы можете поделиться ею.');
      }).catch((err) => {
        console.error('Clipboard error:', err);
        tg.showAlert('Ссылка: ' + miniAppUrl);
      });
    } else {
      tg.showAlert('Ссылка: ' + miniAppUrl);
    }
  }
  
  // Обработка start_param при загрузке страницы
  function handleStartParam() {
    if (!window.Telegram?.WebApp) {
      return;
    }
    
    const tg = window.Telegram.WebApp;
    const startParam = tg.initDataUnsafe?.start_param;
    
    if (startParam) {
      let targetPath = decodeURIComponent(startParam);
      
      // Если это "index", перенаправляем на главную
      if (targetPath === 'index') {
        targetPath = '/';
      } else {
        // Формируем путь: /permalink/
        targetPath = targetPath.replace(/^\/+|\/+$/g, '');
        targetPath = `/${targetPath}/`;
      }
      
      // Перенаправляем только если путь отличается от текущего
      if (targetPath !== window.location.pathname) {
        window.location.href = targetPath;
      }
    }
  }
  
  // Инициализация
  function initShareButton() {
    const shareButton = document.getElementById('share-button');
    if (shareButton) {
      shareButton.addEventListener('click', shareArticle);
    }
    
    // Обрабатываем start_param
    handleStartParam();
  }
  
  // Инициализация при загрузке
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initShareButton);
  } else {
    initShareButton();
  }
})();
</script>
