<div class="share-button-container">
  <button class="share-button" id="share-button" title="Поделиться">
    <svg class="share-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="currentColor"/>
    </svg>
  </button>
</div>

<script>
(function() {
  console.log('ShareButton: Initializing...');
  
  // Получаем shareParam из frontmatter через data-атрибут страницы
  function getShareParam() {
    const body = document.body;
    const shareParam = body.dataset.shareParam;
    
    if (shareParam) {
      console.log('ShareButton: shareParam from data-attribute:', shareParam);
      return shareParam;
    }
    
    // Вычисляем из URL
    const path = window.location.pathname.replace(/^\/+|\/+$/g, '');
    let result = (!path || path === '') ? 'index' : path.replace(/^notes\//, '');
    console.log('ShareButton: shareParam computed from URL:', result);
    return result;
  }
  
  // Получаем bot username
  function getBotUsername() {
    // Сначала пробуем из data-атрибута body (самый надежный способ)
    const body = document.body;
    let botUsername = body.dataset.botUsername;
    console.log('ShareButton: botUsername from data-attribute:', botUsername);
    
    if (botUsername) {
      // Очищаем от пробелов и переносов строк
      const cleaned = botUsername.trim().replace(/[\s\n\r]+/g, '');
      console.log('ShareButton: botUsername cleaned:', cleaned);
      return cleaned;
    }
    
    // Если есть Telegram WebApp, пробуем оттуда
    if (window.Telegram?.WebApp) {
      const tg = window.Telegram.WebApp;
      
      // 1. Из initDataUnsafe
      botUsername = tg.initDataUnsafe?.bot?.username;
      console.log('ShareButton: botUsername from initDataUnsafe:', botUsername);
      
      // 2. Из initData напрямую
      if (!botUsername && tg.initData) {
        try {
          const urlParams = new URLSearchParams(tg.initData);
          const botStr = urlParams.get('bot');
          console.log('ShareButton: botStr from initData:', botStr);
          if (botStr) {
            const bot = JSON.parse(botStr);
            botUsername = bot.username;
            console.log('ShareButton: botUsername from initData:', botUsername);
          }
        } catch (e) {
          console.error('ShareButton: Error parsing bot from initData:', e);
        }
      }
      
      // 3. Пробуем из query параметров URL (если есть)
      if (!botUsername) {
        const urlParams = new URLSearchParams(window.location.search);
        botUsername = urlParams.get('bot');
        console.log('ShareButton: botUsername from URL params:', botUsername);
      }
    }
    
    console.log('ShareButton: Final botUsername:', botUsername);
    return botUsername;
  }
  
  // Функция шаринга
  function shareArticle() {
    console.log('ShareButton: shareArticle called');
    
    const shareParam = getShareParam();
    const botUsername = getBotUsername();
    const hasTelegram = !!window.Telegram?.WebApp;
    
    console.log('ShareButton: shareParam:', shareParam, 'botUsername:', botUsername, 'hasTelegram:', hasTelegram);
    
    if (!hasTelegram) {
      // Если не в Telegram, используем обычный шаринг
      console.log('ShareButton: Not in Telegram, using regular URL');
      const url = window.location.href;
      if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => {
          alert('Ссылка скопирована в буфер обмена!');
        });
      } else {
        alert('Ссылка: ' + url);
      }
      return;
    }
    
    const tg = window.Telegram.WebApp;
    
    if (!botUsername) {
      console.error('ShareButton: Bot username not found');
      console.error('ShareButton: body.dataset:', document.body.dataset);
      console.error('ShareButton: initDataUnsafe:', tg.initDataUnsafe);
      console.error('ShareButton: initData:', tg.initData);
      
      // Пробуем использовать значение по умолчанию из data-атрибута или из конфига
      // Если всё равно не найдено, показываем ошибку
      tg.showAlert('Ошибка: не удалось определить username бота. Проверьте настройки BOT_USERNAME в Vercel.');
      
      // Fallback: копируем обычную ссылку (но это не то, что нужно)
      const url = window.location.href;
      if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => {
          console.warn('ShareButton: Fallback - copied regular URL instead of Mini App link');
        });
      }
      return;
    }
    
    // Создаём ссылку для мини-приложения
    // Формат: https://t.me/botusername?startapp=shareParam
    // shareParam уже транслитерирован на сервере, просто очищаем от лишних символов
    const cleanBotUsername = botUsername.trim().replace(/[\s\n\r@]+/g, ''); // Убираем @ если есть
    const cleanShareParam = shareParam.trim().replace(/[\s\n\r]+/g, '');
    
    // Проверяем, что у нас есть оба параметра
    if (!cleanBotUsername || !cleanShareParam) {
      console.error('ShareButton: Missing required parameters', { cleanBotUsername, cleanShareParam });
      tg.showAlert('Ошибка: не удалось сформировать ссылку. Проверьте настройки.');
      return;
    }
    
    // Формируем ссылку как одну строку без переносов
    // Не используем encodeURIComponent, так как shareParam уже в транслите (латиница)
    const miniAppUrl = `https://t.me/${cleanBotUsername}?startapp=${cleanShareParam}`;
    
    // Проверяем, что ссылка не содержит переносов строк
    const urlWithoutNewlines = miniAppUrl.replace(/[\n\r]/g, '');
    
    console.log('ShareButton: Generated miniAppUrl:', urlWithoutNewlines);
    console.log('ShareButton: cleanBotUsername:', cleanBotUsername);
    console.log('ShareButton: shareParam (original):', shareParam);
    console.log('ShareButton: shareParam (cleaned):', cleanShareParam);
    console.log('ShareButton: URL length:', urlWithoutNewlines.length);
    console.log('ShareButton: URL contains newlines?', urlWithoutNewlines !== miniAppUrl);
    
    // Копируем в буфер обмена (гарантируем отсутствие переносов)
    if (navigator.clipboard) {
      navigator.clipboard.writeText(urlWithoutNewlines).then(() => {
        console.log('ShareButton: ✅ Mini App URL copied to clipboard:', urlWithoutNewlines);
        tg.showAlert('Ссылка скопирована! Теперь вы можете поделиться ею.');
      }).catch((err) => {
        console.error('ShareButton: Clipboard error:', err);
        tg.showAlert('Ссылка: ' + urlWithoutNewlines);
      });
    } else {
      tg.showAlert('Ссылка: ' + urlWithoutNewlines);
    }
  }
  
  // Обработка start_param при загрузке страницы
  function handleStartParam() {
    if (!window.Telegram?.WebApp) {
      return;
    }
    
    const tg = window.Telegram.WebApp;
    let startParam = tg.initDataUnsafe?.start_param;
    
    console.log('ShareButton: startParam (raw):', startParam);
    
    if (startParam) {
      // Декодируем, если это URL-encoded (для обратной совместимости)
      try {
        const decoded = decodeURIComponent(startParam);
        // Если декодирование изменило строку и содержит кириллицу, значит это старый формат
        if (decoded !== startParam && /[а-яё]/i.test(decoded)) {
          console.log('ShareButton: Detected old format (URL-encoded), decoding:', decoded);
          // Транслитерируем кириллицу
          // Простая транслитерация на клиенте (упрощённая версия)
          const translitMap = {
            'а': 'a', 'б': 'b', 'в': 'v', 'г': 'g', 'д': 'd', 'е': 'e', 'ё': 'yo',
            'ж': 'zh', 'з': 'z', 'и': 'i', 'й': 'y', 'к': 'k', 'л': 'l', 'м': 'm',
            'н': 'n', 'о': 'o', 'п': 'p', 'р': 'r', 'с': 's', 'т': 't', 'у': 'u',
            'ф': 'f', 'х': 'h', 'ц': 'ts', 'ч': 'ch', 'ш': 'sh', 'щ': 'sch',
            'ъ': '', 'ы': 'y', 'ь': '', 'э': 'e', 'ю': 'yu', 'я': 'ya'
          };
          startParam = decoded
            .toLowerCase()
            .split('')
            .map(char => translitMap[char] || char)
            .join('')
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
          console.log('ShareButton: Transliterated to:', startParam);
        }
      } catch (e) {
        // Если декодирование не удалось, используем как есть
        console.log('ShareButton: Could not decode, using as is');
      }
      
      // startParam теперь в транслите (латиница)
      let targetPath = startParam;
      
      // Если это "index", перенаправляем на главную
      if (targetPath === 'index') {
        targetPath = '/';
      } else {
        // Формируем путь: /permalink/
        targetPath = targetPath.replace(/^\/+|\/+$/g, '');
        targetPath = `/${targetPath}/`;
      }
      
      console.log('ShareButton: Final targetPath:', targetPath);
      console.log('ShareButton: Current pathname:', window.location.pathname);
      
      // Перенаправляем только если путь отличается от текущего
      if (targetPath !== window.location.pathname) {
        console.log('ShareButton: Redirecting to:', targetPath);
        window.location.href = targetPath;
      } else {
        console.log('ShareButton: Already on target page, no redirect needed');
      }
    }
  }
  
  // Инициализация
  function initShareButton() {
    console.log('ShareButton: initShareButton called');
    const shareButton = document.getElementById('share-button');
    console.log('ShareButton: shareButton element:', shareButton);
    
    if (shareButton) {
      shareButton.addEventListener('click', shareArticle);
      console.log('ShareButton: Event listener added');
    } else {
      console.error('ShareButton: share-button element not found!');
    }
    
    // Обрабатываем start_param
    handleStartParam();
  }
  
  // Инициализация при загрузке
  if (document.readyState === 'loading') {
    console.log('ShareButton: DOM is loading, waiting for DOMContentLoaded');
    document.addEventListener('DOMContentLoaded', initShareButton);
  } else {
    console.log('ShareButton: DOM already loaded, calling initShareButton immediately');
    initShareButton();
  }
})();
</script>
