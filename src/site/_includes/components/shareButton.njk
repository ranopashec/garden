<div class="share-button-container">
  <button class="share-button" onclick="shareArticle()" title="Поделиться" data-article-url="{{ page.url }}">
    <span class="share-icon">✈️</span>
  </button>
</div>

<script>
function shareArticle() {
  if (window.Telegram?.WebApp) {
    const tg = window.Telegram.WebApp;
    
    // Получаем permalink из data-атрибута кнопки или используем текущий путь
    const button = event?.target?.closest('.share-button') || document.querySelector('.share-button');
    const articleUrl = button?.dataset?.articleUrl || window.location.pathname;
    
    // Получаем bot username из initData
    const botUsername = tg.initDataUnsafe?.bot?.username;
    
    if (!botUsername) {
      // Если нет bot username, копируем обычную ссылку
      if (navigator.clipboard) {
        navigator.clipboard.writeText(window.location.href).then(() => {
          tg.showAlert('Ссылка скопирована в буфер обмена!');
        });
      }
      return;
    }
    
    // Кодируем путь статьи как start_param
    // Убираем все слэши и используем чистый путь
    let startParam = articleUrl.replace(/^\/+|\/+$/g, '');
    
    // Если это главная страница, используем "index"
    if (!startParam || startParam === '') {
      startParam = 'index';
    }
    
    // Убираем "notes/" из начала пути, если есть
    startParam = startParam.replace(/^notes\//, '');
    
    // Создаём ссылку для открытия статьи в мини-приложении
    // Формат: https://t.me/botusername/appname?startapp=article_path
    const appName = botUsername;
    const miniAppUrl = `https://t.me/${botUsername}/${appName}?startapp=${encodeURIComponent(startParam)}`;
    
    // Копируем ссылку в буфер обмена
    if (navigator.clipboard) {
      navigator.clipboard.writeText(miniAppUrl).then(() => {
        tg.showAlert('Ссылка скопирована! Теперь вы можете поделиться ею.');
      }).catch(() => {
        tg.showAlert('Ссылка: ' + miniAppUrl);
      });
    } else {
      tg.showAlert('Ссылка: ' + miniAppUrl);
    }
  } else {
    // Если не в Telegram, копируем обычную ссылку
    if (navigator.clipboard) {
      navigator.clipboard.writeText(window.location.href).then(() => {
        alert('Ссылка скопирована в буфер обмена!');
      });
    } else {
      alert('Ссылка: ' + window.location.href);
    }
  }
}

// Обработка start_param при загрузке страницы
(function() {
  if (window.Telegram?.WebApp) {
    const tg = window.Telegram.WebApp;
    const startParam = tg.initDataUnsafe?.start_param;
    
    if (startParam) {
      // Если есть start_param, перенаправляем на соответствующую статью
      // start_param в формате "article_path" (без слэшей)
      let targetPath = decodeURIComponent(startParam);
      
      // Если это "index", перенаправляем на главную
      if (targetPath === 'index') {
        targetPath = '/';
      } else {
        // Формируем путь: /permalink/
        // Убираем возможные слэши и добавляем их программно
        targetPath = targetPath.replace(/^\/+|\/+$/g, '');
        targetPath = `/${targetPath}/`;
      }
      
      // Перенаправляем только если путь отличается от текущего
      if (targetPath !== window.location.pathname) {
        window.location.href = targetPath;
      }
    }
  }
})();
</script>

