{% if access == "private" %}
  <div class="access-gate" data-article-path="{{ page.url }}">
    <div class="access-checking">
      <div class="access-spinner"></div>
      <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞...</p>
    </div>
    <div class="access-denied" style="display: none;">
      <div class="access-denied-icon">üîí</div>
      <h2>–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h2>
      <p>–≠—Ç–∞ —Å—Ç–∞—Ç—å—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</p>
    </div>
    <div class="article-content" style="display: none;">
      {{ content | hideDataview | link | safe }}
    </div>
  </div>
{% else %}
  {{ content | hideDataview | link | safe }}
{% endif %}

<script>
(function() {
  const accessGate = document.querySelector('.access-gate');
  if (!accessGate) return;
  
  if (window.Telegram?.WebApp) {
    const tg = window.Telegram.WebApp;
    const initData = tg.initData;
    
    if (!initData) {
      // –ï—Å–ª–∏ –Ω–µ—Ç initData, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
      accessGate.querySelector('.access-checking').style.display = 'none';
      accessGate.querySelector('.access-denied').style.display = 'block';
      return;
    }
    
    // –ó–∞–ø—Ä–æ—Å –∫ API –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞
    fetch('/api/check-access', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json' 
      },
      body: JSON.stringify({ initData })
    })
    .then(async res => {
      if (!res.ok) {
        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å JSON —Å –¥–µ—Ç–∞–ª—è–º–∏ –æ—à–∏–±–∫–∏
        let errorData = null;
        try {
          errorData = await res.json();
        } catch (e) {
          // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
        }
        throw new Error(errorData?.error || `HTTP ${res.status}`);
      }
      return res.json();
    })
    .then(data => {
      const checkingEl = accessGate.querySelector('.access-checking');
      const deniedEl = accessGate.querySelector('.access-denied');
      const contentEl = accessGate.querySelector('.article-content');
      
      if (data.hasAccess === true) {
        checkingEl.style.display = 'none';
        deniedEl.style.display = 'none';
        contentEl.style.display = 'block';
      } else {
        checkingEl.style.display = 'none';
        deniedEl.style.display = 'block';
        contentEl.style.display = 'none';
      }
    })
    .catch(error => {
      console.error('accessGate: Error checking access:', error);
      const checkingEl = accessGate.querySelector('.access-checking');
      const deniedEl = accessGate.querySelector('.access-denied');
      
      checkingEl.style.display = 'none';
      deniedEl.style.display = 'block';
    });
  } else {
    // –ï—Å–ª–∏ –Ω–µ –≤ Telegram, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    const checkingEl = accessGate.querySelector('.access-checking');
    const deniedEl = accessGate.querySelector('.access-denied');
    
    checkingEl.style.display = 'none';
    deniedEl.style.display = 'block';
  }
})();
</script>

