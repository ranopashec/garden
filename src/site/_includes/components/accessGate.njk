{% if access == "private" %}
  <div class="access-gate" data-article-path="{{ page.url }}">
    <div class="access-checking">
      <div class="access-spinner"></div>
      <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞...</p>
    </div>
    <div class="access-denied" style="display: none;">
      <div class="access-denied-icon">üîí</div>
      <h2>–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h2>
      <p>–≠—Ç–∞ —Å—Ç–∞—Ç—å—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</p>
      <div id="access-debug-info" style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.9em; display: none;">
        <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:</strong>
        <div id="debug-content"></div>
      </div>
    </div>
    <div class="article-content" style="display: none;">
      {{ content | hideDataview | link | safe }}
    </div>
  </div>
{% else %}
  {{ content | hideDataview | link | safe }}
{% endif %}

<script>
(function() {
  const accessGate = document.querySelector('.access-gate');
  if (!accessGate) return;
  
  if (window.Telegram?.WebApp) {
    const tg = window.Telegram.WebApp;
    const initData = tg.initData;
    
    if (!initData) {
      // –ï—Å–ª–∏ –Ω–µ—Ç initData, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
      accessGate.querySelector('.access-checking').style.display = 'none';
      accessGate.querySelector('.access-denied').style.display = 'block';
      return;
    }
    
    // –ó–∞–ø—Ä–æ—Å –∫ API –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞
    fetch('/api/check-access', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json' 
      },
      body: JSON.stringify({ initData })
    })
    .then(async res => {
      if (!res.ok) {
        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å JSON —Å –¥–µ—Ç–∞–ª—è–º–∏ –æ—à–∏–±–∫–∏
        let errorData = null;
        try {
          errorData = await res.json();
        } catch (e) {
          // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
        }
        throw new Error(errorData?.error || `HTTP ${res.status}`);
      }
      return res.json();
    })
    .then(data => {
      console.log('accessGate: Access check result:', data);
      console.log('accessGate: Full response:', JSON.stringify(data, null, 2));
      
      const checkingEl = accessGate.querySelector('.access-checking');
      const deniedEl = accessGate.querySelector('.access-denied');
      const contentEl = accessGate.querySelector('.article-content');
      const debugInfo = document.getElementById('access-debug-info');
      const debugContent = document.getElementById('debug-content');
      
      if (data.hasAccess === true) {
        console.log('accessGate: Access granted');
        checkingEl.style.display = 'none';
        deniedEl.style.display = 'none';
        contentEl.style.display = 'block';
      } else {
        console.log('accessGate: Access denied');
        console.log('accessGate: Debug info:', data.debug);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—Ç–∫–∞–∑–µ
        if (data.debug) {
          let debugHtml = '';
          
          if (data.debug.requestedUsername) {
            debugHtml += `<div style="margin: 10px 0;"><strong>–í–∞—à username:</strong> @${data.debug.requestedUsername}</div>`;
          }
          
          if (data.debug.acceptedUsernames && data.debug.acceptedUsernames.length > 0) {
            debugHtml += `<div style="margin: 10px 0;"><strong>–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ username:</strong><br>`;
            debugHtml += data.debug.acceptedUsernames.map(u => `@${u}`).join(', ');
            debugHtml += `</div>`;
          }
          
          if (data.debug.match !== undefined) {
            debugHtml += `<div style="margin: 10px 0; color: ${data.debug.match ? '#4caf50' : '#f44336'}"><strong>–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ:</strong> ${data.debug.match ? '‚úì –ù–∞–π–¥–µ–Ω–æ' : '‚úó –ù–µ –Ω–∞–π–¥–µ–Ω–æ'}</div>`;
          }
          
          if (debugContent) {
            debugContent.innerHTML = debugHtml;
            if (debugInfo) {
              debugInfo.style.display = 'block';
            }
          }
        } else {
          // –ï—Å–ª–∏ –Ω–µ—Ç debug, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –µ—Å—Ç—å
          if (data.username) {
            if (debugContent) {
              debugContent.innerHTML = `<div style="margin: 10px 0;"><strong>–í–∞—à username:</strong> @${data.username}</div>`;
              if (debugInfo) {
                debugInfo.style.display = 'block';
              }
            }
          }
        }
        
        checkingEl.style.display = 'none';
        deniedEl.style.display = 'block';
        contentEl.style.display = 'none';
      }
    })
    .catch(error => {
      console.error('accessGate: Error checking access:', error);
      const checkingEl = accessGate.querySelector('.access-checking');
      const deniedEl = accessGate.querySelector('.access-denied');
      
      checkingEl.style.display = 'none';
      deniedEl.style.display = 'block';
    });
  } else {
    // –ï—Å–ª–∏ –Ω–µ –≤ Telegram, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    const checkingEl = accessGate.querySelector('.access-checking');
    const deniedEl = accessGate.querySelector('.access-denied');
    
    checkingEl.style.display = 'none';
    deniedEl.style.display = 'block';
  }
})();
</script>

