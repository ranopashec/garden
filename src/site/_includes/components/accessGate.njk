{% if access == "public" %}
  {# –ü—É–±–ª–∏—á–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ–º #}
  {{ content | hideDataview | link | safe }}
{% elif access == "private" or private == true %}
  {# –ü—Ä–∏–≤–∞—Ç–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ Supabase #}
  <div id="access-gate-container" class="access-gate" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; padding: 2rem; width: 100%;">
    <div class="access-denied-icon" style="font-size: 4rem; margin-bottom: 1.5rem;">üîí</div>
    <h2 style="margin-bottom: 1rem; font-size: 1.8rem;">–í–∞–º –∑–∞–ø—Ä–µ—â—ë–Ω –¥–æ—Å—Ç—É–ø –∫ —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–µ</h2>
    <a href="/" style="display: inline-block; margin-top: 1.5rem; padding: 0.75rem 2rem; background-color: var(--interactive-accent, #4a9eff); color: white; text-decoration: none; border-radius: 6px; font-weight: 500; transition: opacity 0.2s;">
      –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
    </a>
  </div>
  <div id="private-content" style="display: none;">
    {{ content | hideDataview | link | safe }}
  </div>
  <script>
  (function() {
    const accessGateContainer = document.getElementById('access-gate-container');
    const privateContent = document.getElementById('private-content');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ Supabase (–∏—Å–ø–æ–ª—å–∑—É—è –∫—ç—à –∏–∑ localStorage)
    async function checkAccess() {
      try {
        // –ü–æ–ª—É—á–∞–µ–º Telegram ID –∏–∑ Telegram WebApp
        const tg = window.Telegram?.WebApp;
        if (!tg || !tg.initDataUnsafe?.user) {
          console.warn('AccessGate: Telegram WebApp not available or user data missing');
          return; // –û—Å—Ç–∞–≤–ª—è–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
        }
        
        const user = tg.initDataUnsafe.user;
        const telegramId = user.id;
        
        if (!telegramId) {
          console.warn('AccessGate: Telegram ID not available');
          return; // –û—Å—Ç–∞–≤–ª—è–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à –≤ localStorage
        const cacheKey = `subscription_${telegramId}`;
        const cachedData = localStorage.getItem(cacheKey);
        
        let data;
        if (cachedData) {
          try {
            const parsed = JSON.parse(cachedData);
            const cacheTime = parsed.timestamp || 0;
            const now = Date.now();
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—Ç–∞—Ä—à–µ 5 –º–∏–Ω—É—Ç
            if (now - cacheTime < 5 * 60 * 1000) {
              data = parsed.data;
              console.log('AccessGate: Using cached subscription data');
            }
          } catch (e) {
            console.warn('AccessGate: Failed to parse cache', e);
          }
        }
        
        // –ï—Å–ª–∏ –∫—ç—à–∞ –Ω–µ—Ç - –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å (–Ω–æ —ç—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–µ–¥–∫–æ, —Ç–∞–∫ –∫–∞–∫ telegramAuth —É–∂–µ –∑–∞–≥—Ä—É–∑–∏–ª –¥–∞–Ω–Ω—ã–µ)
        if (!data) {
          const response = await fetch('/api/check-access', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ telegramId: telegramId })
          });
          
          if (!response.ok) {
            console.error('AccessGate: API request failed', response.status);
            return; // –û—Å—Ç–∞–≤–ª—è–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
          }
          
          data = await response.json();
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
          localStorage.setItem(cacheKey, JSON.stringify({
            data: data,
            timestamp: Date.now()
          }));
        }
        
        if (data.hasAccess) {
          // –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
          if (accessGateContainer) {
            accessGateContainer.style.display = 'none';
          }
          if (privateContent) {
            privateContent.style.display = 'block';
          }
          console.log('AccessGate: ‚úÖ Access granted for Telegram ID', telegramId);
        } else {
          // –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω - –æ—Å—Ç–∞–≤–ª—è–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
          console.log('AccessGate: ‚ùå Access denied for Telegram ID', telegramId);
        }
        
      } catch (error) {
        console.error('AccessGate: Error checking access', error);
        // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
      }
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', checkAccess);
    } else {
      checkAccess();
    }
    
    // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram WebApp (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)
    setTimeout(checkAccess, 500);
  })();
  </script>
{% else %}
  {# access == "none" –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç - –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∏–∫–æ–º—É #}
  <div class="access-gate" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; padding: 2rem; width: 100%;">
    <div class="access-denied-icon" style="font-size: 4rem; margin-bottom: 1.5rem;">üîí</div>
    <h2 style="margin-bottom: 1rem; font-size: 1.8rem;">–í–∞–º –∑–∞–ø—Ä–µ—â—ë–Ω –¥–æ—Å—Ç—É–ø –∫ —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–µ</h2>
    <a href="/" style="display: inline-block; margin-top: 1.5rem; padding: 0.75rem 2rem; background-color: var(--interactive-accent, #4a9eff); color: white; text-decoration: none; border-radius: 6px; font-weight: 500; transition: opacity 0.2s;">
      –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
    </a>
  </div>
{% endif %}

