<div id="telegram-gate" style="display: block;">
  <div class="telegram-gate-overlay">
    <div class="telegram-gate-content">
      <div class="telegram-gate-icon">üì±</div>
      <h1 class="telegram-gate-title">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Telegram</h1>
      <p class="telegram-gate-message">
        –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram Mini App.
        –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –≤ Telegram.
      </p>
      {% if meta.botUsername %}
      <a href="https://t.me/{{ meta.botUsername }}" class="telegram-gate-button" target="_blank">
        –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
      </a>
      {% endif %}
    </div>
  </div>
</div>

<script>
(function() {
  let accessGranted = false;
  let checkInterval = null;
  
  function grantAccess() {
    if (accessGranted) return;
    
    accessGranted = true;
    const telegramGate = document.getElementById('telegram-gate');
    const mainContent = document.querySelector('main.content');
    const userInfo = document.getElementById('user-info');
    
    if (telegramGate) {
      telegramGate.style.display = 'none';
    }
    if (mainContent) {
      mainContent.style.display = 'block';
    }
    if (userInfo) {
      userInfo.style.display = 'flex';
    }
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏
    if (checkInterval) {
      clearInterval(checkInterval);
      checkInterval = null;
    }
    
    console.log('TelegramGate: ‚úÖ Access granted - Telegram WebApp available');
  }
  
  function denyAccess() {
    if (accessGranted) return;
    
    const telegramGate = document.getElementById('telegram-gate');
    const mainContent = document.querySelector('main.content');
    const userInfo = document.getElementById('user-info');
    
    if (telegramGate) {
      telegramGate.style.display = 'block';
    }
    if (mainContent) {
      mainContent.style.display = 'none';
    }
    if (userInfo) {
      userInfo.style.display = 'none';
    }
    
    console.warn('TelegramGate: ‚ùå Access denied - Telegram WebApp not available');
  }
  
  function checkTelegramAccess() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Telegram WebApp
    const hasTelegram = !!window.Telegram?.WebApp;
    const hasTelegramObject = !!window.Telegram;
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏: –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –≤ iframe (Telegram –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Mini Apps –≤ iframe)
    const isInIframe = window.self !== window.top;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ Telegram –≤ DOM
    const telegramScript = document.querySelector('script[src*="telegram-web-app"]');
    
    console.log('TelegramGate: Checking access');
    console.log('  - window.Telegram exists?', hasTelegramObject);
    console.log('  - window.Telegram.WebApp exists?', hasTelegram);
    console.log('  - isInIframe?', isInIframe);
    console.log('  - telegramScript in DOM?', !!telegramScript);
    
    if (hasTelegram) {
      grantAccess();
      return true;
    }
    
    // –ï—Å–ª–∏ –º—ã –≤ iframe –∏ –µ—Å—Ç—å –æ–±—ä–µ–∫—Ç Telegram, –Ω–æ WebApp –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω - –∂–¥—ë–º
    if (isInIframe && hasTelegramObject) {
      console.log('TelegramGate: ‚è≥ In iframe with Telegram object, waiting for WebApp...');
      return false;
    }
    
    // –ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç Telegram –Ω–∞–π–¥–µ–Ω –≤ DOM, –Ω–æ WebApp –µ—â—ë –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω - –∂–¥—ë–º
    if (telegramScript && !hasTelegram) {
      console.log('TelegramGate: ‚è≥ Telegram script found, waiting for WebApp...');
      return false;
    }
    
    // –ï—Å–ª–∏ –º—ã –≤ iframe, –Ω–æ Telegram –Ω–µ –Ω–∞–π–¥–µ–Ω - –≤–æ–∑–º–æ–∂–Ω–æ, –æ–Ω –µ—â—ë –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
    if (isInIframe && !hasTelegramObject) {
      console.log('TelegramGate: ‚è≥ In iframe but Telegram not found yet, waiting...');
      return false;
    }
    
    // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏ –º—ã –Ω–µ –≤ iframe - –±–ª–æ–∫–∏—Ä—É–µ–º
    if (!isInIframe && !hasTelegramObject) {
      denyAccess();
      return false;
    }
    
    return false;
  }
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º MutationObserver –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è window.Telegram
  function setupTelegramObserver() {
    let observerCount = 0;
    const maxObservations = 100; // –ú–∞–∫—Å–∏–º—É–º 10 —Å–µ–∫—É–Ω–¥ (100 * 100ms)
    
    const observer = new MutationObserver(() => {
      observerCount++;
      if (window.Telegram?.WebApp) {
        console.log('TelegramGate: MutationObserver detected Telegram WebApp');
        grantAccess();
        observer.disconnect();
      } else if (observerCount >= maxObservations) {
        console.warn('TelegramGate: MutationObserver timeout');
        observer.disconnect();
        if (!accessGranted) {
          denyAccess();
        }
      }
    });
    
    // –ù–∞–±–ª—é–¥–∞–µ–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ document
    observer.observe(document.documentElement, {
      childList: true,
      subtree: true,
      attributes: true,
      attributeFilter: ['src']
    });
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
      observer.disconnect();
    }, 10000);
  }
  
  // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
  function initTelegramGate() {
    console.log('TelegramGate: Initializing...');
    
    // –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–∞–∑—É
    if (checkTelegramAccess()) {
      return;
    }
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º MutationObserver
    setupTelegramObserver();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 100ms –≤ —Ç–µ—á–µ–Ω–∏–µ 10 —Å–µ–∫—É–Ω–¥
    let attempts = 0;
    const maxAttempts = 100; // 10 —Å–µ–∫—É–Ω–¥
    
    checkInterval = setInterval(() => {
      attempts++;
      if (accessGranted) {
        clearInterval(checkInterval);
        checkInterval = null;
        return;
      }
      
      if (checkTelegramAccess()) {
        clearInterval(checkInterval);
        checkInterval = null;
        return;
      }
      
      if (attempts >= maxAttempts) {
        clearInterval(checkInterval);
        checkInterval = null;
        console.warn('TelegramGate: Max attempts reached');
        if (!accessGranted) {
          denyAccess();
        }
      }
    }, 100);
    
    // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
      if (!accessGranted) {
        console.warn('TelegramGate: Final check after 10 seconds');
        if (checkTelegramAccess()) {
          grantAccess();
        } else {
          denyAccess();
        }
      }
    }, 10000);
  }
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTelegramGate);
  } else {
    initTelegramGate();
  }
  
  // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  window.addEventListener('load', () => {
    setTimeout(() => {
      if (!accessGranted) {
        console.log('TelegramGate: Checking after window.load event');
        if (checkTelegramAccess()) {
          grantAccess();
        }
      }
    }, 500);
  });
})();
</script>
