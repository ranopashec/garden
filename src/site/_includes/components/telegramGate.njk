<div id="telegram-gate" style="display: block;">
  <div class="telegram-gate-overlay">
    <div class="telegram-gate-content">
      <div class="telegram-gate-icon">üì±</div>
      <h1 class="telegram-gate-title">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Telegram</h1>
      <p class="telegram-gate-message">
        –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram Mini App.
        –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –≤ Telegram.
      </p>
      {% if meta.botUsername %}
      <a href="https://t.me/{{ meta.botUsername }}" class="telegram-gate-button" target="_blank">
        –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
      </a>
      {% endif %}
    </div>
  </div>
</div>

<script>
(function() {
  let accessGranted = false;
  let checkInterval = null;
  
  function grantAccess() {
    if (accessGranted) return;
    
    accessGranted = true;
    const telegramGate = document.getElementById('telegram-gate');
    const mainContent = document.querySelector('main.content');
    const userInfo = document.getElementById('user-info');
    
    if (telegramGate) {
      telegramGate.style.display = 'none';
    }
    if (mainContent) {
      mainContent.style.display = 'block';
    }
    if (userInfo) {
      userInfo.style.display = 'flex';
    }
    
    if (checkInterval) {
      clearInterval(checkInterval);
      checkInterval = null;
    }
    
    console.log('TelegramGate: ‚úÖ Access granted - Telegram WebApp available');
  }
  
  function denyAccess() {
    if (accessGranted) return;
    
    const telegramGate = document.getElementById('telegram-gate');
    const mainContent = document.querySelector('main.content');
    const userInfo = document.getElementById('user-info');
    
    if (telegramGate) {
      telegramGate.style.display = 'block';
    }
    if (mainContent) {
      mainContent.style.display = 'none';
    }
    if (userInfo) {
      userInfo.style.display = 'none';
    }
    
    if (checkInterval) {
      clearInterval(checkInterval);
      checkInterval = null;
    }
    
    console.warn('TelegramGate: ‚ùå Access denied - Telegram WebApp not available');
  }
  
  function checkTelegramAccess() {
    const tg = window.Telegram?.WebApp;
    const hasTelegram = !!tg && typeof tg.ready === 'function';
    
    if (hasTelegram) {
      grantAccess();
      return true;
    }
    
    return false;
  }
  
  function initTelegramGate() {
    console.log('TelegramGate: Initializing...');
    console.log('TelegramGate: window.Telegram initially:', window.Telegram);
    console.log('TelegramGate: window.Telegram.WebApp initially:', window.Telegram?.WebApp);
    
    const isInIframe = window.self !== window.top;
    console.log('TelegramGate: isInIframe?', isInIframe);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–∞–∑—É
    if (checkTelegramAccess()) {
      return;
    }
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∞–π–º–∞—É—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –≤ iframe –º—ã –∏–ª–∏ –Ω–µ—Ç
    // –í iframe (Telegram) –¥–∞—ë–º –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É
    // –í–Ω–µ iframe (–æ–±—ã—á–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä) –±–ª–æ–∫–∏—Ä—É–µ–º –±—ã—Å—Ç—Ä–µ–µ
    const timeout = isInIframe ? 10000 : 3000; // 10 —Å–µ–∫ –¥–ª—è iframe, 3 —Å–µ–∫ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞
    const checkIntervalMs = 100;
    const maxChecks = Math.floor(timeout / checkIntervalMs);
    let checkCount = 0;
    
    console.log(`TelegramGate: Will check for ${timeout}ms (${maxChecks} attempts)`);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 100ms
    checkInterval = setInterval(() => {
      checkCount++;
      
      if (accessGranted) {
        clearInterval(checkInterval);
        checkInterval = null;
        return;
      }
      
      if (checkTelegramAccess()) {
        clearInterval(checkInterval);
        checkInterval = null;
        return;
      }
      
      // –ï—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫ - –±–ª–æ–∫–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø
      if (checkCount >= maxChecks) {
        clearInterval(checkInterval);
        checkInterval = null;
        console.warn(`TelegramGate: Timeout after ${timeout}ms, blocking access`);
        denyAccess();
      }
    }, checkIntervalMs);
    
    // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ —Ç–∞–π–º–∞—É—Ç
    setTimeout(() => {
      if (!accessGranted) {
        console.warn(`TelegramGate: Final check after ${timeout}ms`);
        if (checkTelegramAccess()) {
          grantAccess();
        } else {
          denyAccess();
        }
      }
    }, timeout);
  }
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTelegramGate);
  } else {
    initTelegramGate();
  }
  
  // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  window.addEventListener('load', () => {
    setTimeout(() => {
      if (!accessGranted) {
        console.log('TelegramGate: Checking after window.load event');
        if (checkTelegramAccess()) {
          grantAccess();
        }
      }
    }, 500);
  });
})();
</script>
