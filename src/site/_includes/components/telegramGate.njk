<div id="telegram-gate" style="display: block;">
  <div class="telegram-gate-overlay">
    <div class="telegram-gate-content">
      <div class="telegram-gate-icon">üì±</div>
      <h1 class="telegram-gate-title">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Telegram</h1>
      <p class="telegram-gate-message">
        –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram Mini App.
        –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –≤ Telegram.
      </p>
      {% if meta.botUsername %}
      <a href="https://t.me/{{ meta.botUsername }}" class="telegram-gate-button" target="_blank">
        –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
      </a>
      {% endif %}
    </div>
  </div>
</div>

<script>
(function() {
  let accessGranted = false;
  let checkCount = 0;
  const maxChecks = 150; // 15 —Å–µ–∫—É–Ω–¥ (150 * 100ms)
  
  function grantAccess() {
    if (accessGranted) return;
    
    accessGranted = true;
    const telegramGate = document.getElementById('telegram-gate');
    const mainContent = document.querySelector('main.content');
    const userInfo = document.getElementById('user-info');
    
    if (telegramGate) {
      telegramGate.style.display = 'none';
    }
    if (mainContent) {
      mainContent.style.display = 'block';
    }
    if (userInfo) {
      userInfo.style.display = 'flex';
    }
    
    console.log('TelegramGate: ‚úÖ Access granted - Telegram WebApp available');
    console.log('TelegramGate: WebApp object:', window.Telegram?.WebApp);
  }
  
  function denyAccess() {
    if (accessGranted) return;
    
    const telegramGate = document.getElementById('telegram-gate');
    const mainContent = document.querySelector('main.content');
    const userInfo = document.getElementById('user-info');
    
    if (telegramGate) {
      telegramGate.style.display = 'block';
    }
    if (mainContent) {
      mainContent.style.display = 'none';
    }
    if (userInfo) {
      userInfo.style.display = 'none';
    }
    
    console.warn('TelegramGate: ‚ùå Access denied - Telegram WebApp not available');
    console.warn('TelegramGate: window.Telegram:', window.Telegram);
    console.warn('TelegramGate: window.Telegram.WebApp:', window.Telegram?.WebApp);
  }
  
  function checkTelegramAccess() {
    checkCount++;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Telegram WebApp
    const tg = window.Telegram?.WebApp;
    const hasTelegram = !!tg;
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
    const hasTelegramObject = !!window.Telegram;
    const isInIframe = window.self !== window.top;
    
    // –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–µ 10 –ø—Ä–æ–≤–µ—Ä–æ–∫
    if (checkCount % 10 === 0 || hasTelegram) {
      console.log(`TelegramGate: Check #${checkCount}`);
      console.log('  - window.Telegram exists?', hasTelegramObject);
      console.log('  - window.Telegram.WebApp exists?', hasTelegram);
      console.log('  - isInIframe?', isInIframe);
      if (tg) {
        console.log('  - tg.version:', tg.version);
        console.log('  - tg.platform:', tg.platform);
        console.log('  - tg.initDataUnsafe:', tg.initDataUnsafe);
      }
    }
    
    if (hasTelegram) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ WebApp –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
      // –ò–Ω–æ–≥–¥–∞ –æ–±—ä–µ–∫—Ç –º–æ–∂–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å, –Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º
      if (tg && typeof tg.ready === 'function') {
        grantAccess();
        return true;
      } else {
        console.warn('TelegramGate: WebApp object exists but not properly initialized');
      }
    }
    
    // –ï—Å–ª–∏ –º—ã –≤ iframe, –¥–∞—ë–º –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É
    if (isInIframe) {
      if (checkCount < maxChecks) {
        return false; // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å
      } else {
        // –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤ iframe - –±–ª–æ–∫–∏—Ä—É–µ–º
        denyAccess();
        return false;
      }
    }
    
    // –ï—Å–ª–∏ –Ω–µ –≤ iframe –∏ –ø—Ä–æ—à–ª–æ –º–Ω–æ–≥–æ –ø—Ä–æ–≤–µ—Ä–æ–∫ - –±–ª–æ–∫–∏—Ä—É–µ–º
    if (checkCount >= 50) { // 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –Ω–µ-iframe
      denyAccess();
      return false;
    }
    
    return false;
  }
  
  // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
  function initTelegramGate() {
    console.log('TelegramGate: Initializing...');
    console.log('TelegramGate: Document readyState:', document.readyState);
    console.log('TelegramGate: window.Telegram initially:', window.Telegram);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–∞–∑—É
    if (checkTelegramAccess()) {
      return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 100ms
    const checkInterval = setInterval(() => {
      if (accessGranted) {
        clearInterval(checkInterval);
        return;
      }
      
      if (checkTelegramAccess()) {
        clearInterval(checkInterval);
        return;
      }
      
      if (checkCount >= maxChecks) {
        clearInterval(checkInterval);
        if (!accessGranted) {
          denyAccess();
        }
      }
    }, 100);
    
    // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
      if (!accessGranted) {
        console.warn('TelegramGate: Final check after 15 seconds');
        if (checkTelegramAccess()) {
          grantAccess();
        } else {
          denyAccess();
        }
      }
    }, 15000);
  }
  
  // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞ Telegram
  function waitForTelegramScript() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ —Å–∫—Ä–∏–ø—Ç
    const script = document.querySelector('script[src*="telegram-web-app"]');
    if (script) {
      console.log('TelegramGate: Telegram script found in DOM');
      // –î–∞—ë–º —Å–∫—Ä–∏–ø—Ç—É –≤—Ä–µ–º—è –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
      setTimeout(initTelegramGate, 100);
    } else {
      console.warn('TelegramGate: Telegram script not found in DOM, waiting...');
      // –ü—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑ —á–µ—Ä–µ–∑ 500ms
      setTimeout(waitForTelegramScript, 500);
    }
  }
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      waitForTelegramScript();
    });
  } else {
    waitForTelegramScript();
  }
  
  // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  window.addEventListener('load', () => {
    setTimeout(() => {
      if (!accessGranted) {
        console.log('TelegramGate: Checking after window.load event');
        if (checkTelegramAccess()) {
          grantAccess();
        }
      }
    }, 500);
  });
})();
</script>
