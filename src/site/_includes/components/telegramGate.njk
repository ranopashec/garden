<div id="telegram-gate" style="display: block;">
  <div class="telegram-gate-overlay">
    <div class="telegram-gate-content">
      <div class="telegram-gate-icon">üì±</div>
      <h1 class="telegram-gate-title">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Telegram</h1>
      <p class="telegram-gate-message">
        –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram Mini App.
        –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –≤ Telegram.
      </p>
      {% if meta.botUsername %}
      <a href="https://t.me/{{ meta.botUsername }}" class="telegram-gate-button" target="_blank">
        –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
      </a>
      {% endif %}
    </div>
  </div>
</div>

<script>
(function() {
  let accessGranted = false;
  let checkInterval = null;
  let finalCheckTimeout = null;
  
  function grantAccess() {
    if (accessGranted) return;
    
    accessGranted = true;
    const telegramGate = document.getElementById('telegram-gate');
    const mainContent = document.querySelector('main.content');
    const userInfo = document.getElementById('user-info');
    
    if (telegramGate) {
      telegramGate.style.display = 'none';
    }
    if (mainContent) {
      mainContent.style.display = 'block';
    }
    if (userInfo) {
      userInfo.style.display = 'flex';
    }
    
    if (checkInterval) {
      clearInterval(checkInterval);
      checkInterval = null;
    }
    if (finalCheckTimeout) {
      clearTimeout(finalCheckTimeout);
      finalCheckTimeout = null;
    }
    
    console.log('TelegramGate: ‚úÖ Access granted - Telegram WebApp available');
  }
  
  function denyAccess() {
    if (accessGranted) return;
    
    const telegramGate = document.getElementById('telegram-gate');
    const mainContent = document.querySelector('main.content');
    const userInfo = document.getElementById('user-info');
    
    if (telegramGate) {
      telegramGate.style.display = 'block';
    }
    if (mainContent) {
      mainContent.style.display = 'none';
    }
    if (userInfo) {
      userInfo.style.display = 'none';
    }
    
    if (checkInterval) {
      clearInterval(checkInterval);
      checkInterval = null;
    }
    if (finalCheckTimeout) {
      clearTimeout(finalCheckTimeout);
      finalCheckTimeout = null;
    }
    
    console.warn('TelegramGate: ‚ùå Access denied - Telegram WebApp not available');
  }
  
  function checkTelegramAccess() {
    // –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å window.Telegram.WebApp
    // –∏ —É –Ω–µ–≥–æ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –º–µ—Ç–æ–¥—ã ready, expand –∏ –¥—Ä—É–≥–∏–µ
    const tg = window.Telegram?.WebApp;
    
    if (!tg) {
      return false;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ Telegram WebApp –æ–±—ä–µ–∫—Ç
    // –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∏ —Å–≤–æ–π—Å—Ç–≤–∞
    const hasRequiredMethods = typeof tg.ready === 'function' && 
                                typeof tg.expand === 'function' &&
                                typeof tg.initDataUnsafe !== 'undefined';
    
    if (hasRequiredMethods) {
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –º—ã –Ω–µ –≤ iframe, –Ω–æ –µ—Å—Ç—å Telegram WebApp,
      // —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–¥–¥–µ–ª–∫–∞ - –ø—Ä–æ–≤–µ—Ä—è–µ–º initData
      const isInIframe = window.self !== window.top;
      if (!isInIframe && tg.initDataUnsafe) {
        // –ï—Å–ª–∏ –Ω–µ –≤ iframe, –Ω–æ –µ—Å—Ç—å initData - –≤–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ —Ç–µ—Å—Ç–æ–≤–∞—è —Å—Ä–µ–¥–∞
        // –†–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const hasUserData = tg.initDataUnsafe.user && 
                           (tg.initDataUnsafe.user.id || tg.initDataUnsafe.user.username);
        if (!hasUserData) {
          console.warn('TelegramGate: WebApp found but no user data, might be fake');
          return false;
        }
      }
      
      grantAccess();
      return true;
    }
    
    return false;
  }
  
  function initTelegramGate() {
    console.log('TelegramGate: Initializing...');
    console.log('TelegramGate: window.Telegram initially:', window.Telegram);
    console.log('TelegramGate: window.Telegram.WebApp initially:', window.Telegram?.WebApp);
    
    const isInIframe = window.self !== window.top;
    console.log('TelegramGate: isInIframe?', isInIframe);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–∞–∑—É
    if (checkTelegramAccess()) {
      return;
    }
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∞–π–º–∞—É—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –≤ iframe –º—ã –∏–ª–∏ –Ω–µ—Ç
    // –í iframe (Telegram) –¥–∞—ë–º –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É
    // –í–Ω–µ iframe (–æ–±—ã—á–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä) –±–ª–æ–∫–∏—Ä—É–µ–º –±—ã—Å—Ç—Ä–µ–µ
    const timeout = isInIframe ? 10000 : 2000; // 10 —Å–µ–∫ –¥–ª—è iframe, 2 —Å–µ–∫ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞
    const checkIntervalMs = 100;
    const maxChecks = Math.floor(timeout / checkIntervalMs);
    let checkCount = 0;
    
    console.log(`TelegramGate: Will check for ${timeout}ms (${maxChecks} attempts)`);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 100ms
    checkInterval = setInterval(() => {
      checkCount++;
      
      if (accessGranted) {
        clearInterval(checkInterval);
        checkInterval = null;
        return;
      }
      
      if (checkTelegramAccess()) {
        clearInterval(checkInterval);
        checkInterval = null;
        return;
      }
      
      // –ï—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫ - –±–ª–æ–∫–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø
      if (checkCount >= maxChecks) {
        clearInterval(checkInterval);
        checkInterval = null;
        console.warn(`TelegramGate: Timeout after ${timeout}ms, blocking access`);
        denyAccess();
      }
    }, checkIntervalMs);
    
    // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ —Ç–∞–π–º–∞—É—Ç - –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û –±–ª–æ–∫–∏—Ä—É–µ–º, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
    finalCheckTimeout = setTimeout(() => {
      if (!accessGranted) {
        console.warn(`TelegramGate: Final check after ${timeout}ms`);
        if (checkTelegramAccess()) {
          grantAccess();
        } else {
          // –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–ê–Ø –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
          console.error('TelegramGate: Telegram WebApp not found, BLOCKING ACCESS');
          denyAccess();
        }
      }
    }, timeout);
  }
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTelegramGate);
  } else {
    initTelegramGate();
  }
  
  // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –Ω–æ –ù–ï —Ä–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
  window.addEventListener('load', () => {
    setTimeout(() => {
      if (!accessGranted) {
        console.log('TelegramGate: Checking after window.load event');
        // –¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–æ –Ω–µ —Ä–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        // –ï—Å–ª–∏ Telegram –Ω–µ –Ω–∞–π–¥–µ–Ω, denyAccess —É–∂–µ –±—ã–ª –≤—ã–∑–≤–∞–Ω
        checkTelegramAccess();
      }
    }, 500);
  });
})();
</script>
